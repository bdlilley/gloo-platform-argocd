# charts - each key is a helm chart install
charts:

  # cert-manager for issuing certs
  cert-manager:
    repo: https://charts.jetstack.io
    revision: v1.9.1
    chart: cert-manager
    namespace: cert-manager
    values:
      installCRDs: true

  # a cert-manager clusterIssuer named "selfsigned"
  selfsigned:
    path: charts/cluster-issuer
    namespace: kube-system
    syncPolicy:
      syncOptions: [] # dont create namespace

  aws-load-balancer-controller:
    repo: https://aws.github.io/eks-charts
    chart: aws-load-balancer-controller
    revision: "1.4.5"
    namespace: kube-system
    syncPolicy:
      syncOptions: [] # dont create namespace
    values:
      clusterName: ben
      replicaCount: 1
      serviceAccount:
        create: false
        name: aws-load-balancer-controller
  
  istio-base:
    repo: https://istio-release.storage.googleapis.com/charts
    chart: base
    namespace: istio-system
    revision: "1.15.0"

  istiod-15-0:
    repo: https://istio-release.storage.googleapis.com/charts
    chart: istiod
    revision: "1.15.0"
    namespace: istio-system
    syncPolicy:
      syncOptions: [] # dont create namespace
    globalValues:
      meshID: mesh1
      multiCluster:
        clusterName: mgmt
      network: network1
      hub: us-docker.pkg.dev/gloo-mesh/istio-1cf99a48c9d8
      tag: 1.15.0-solo
    values:
      revision: 1-15
      meshConfig:
        trustDomain: mgmt
        accessLogFile: /dev/stdout
        enableAutoMtls: true
        defaultConfig:
          envoyMetricsService:
            address: gloo-mesh-agent.gloo-mesh:9977
          envoyAccessLogService:
            address: gloo-mesh-agent.gloo-mesh:9977
          proxyMetadata:
            ISTIO_META_DNS_CAPTURE: "true"
            ISTIO_META_DNS_AUTO_ALLOCATE: "true"
            GLOO_MESH_CLUSTER_NAME: mgmt
      pilot:
        env:
          PILOT_ENABLE_K8S_SELECT_WORKLOAD_ENTRIES: "false"
          PILOT_SKIP_VALIDATE_TRUST_DOMAIN: "true"

  istio-ingressgateway:
    repo: https://istio-release.storage.googleapis.com/charts
    chart: gateway
    namespace: istio-gateways
    revision: "1.15.0"
    values:
      revision: "1-15"
      labels:
        istio: ingressgateway
        istio.io/rev: 1-15
      annotations:
        proxy.istio.io/config: '{ "holdApplicationUntilProxyStarts": true }'
      service:
        type: LoadBalancer
        annotations:
          service.beta.kubernetes.io/aws-load-balancer-scheme: internal
          service.beta.kubernetes.io/aws-load-balancer-type: nlb-ip
          service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: "true"
        ports:
        # main http ingress port
        - port: 80
          targetPort: 80
          name: http2
        # main https ingress port
        - port: 443
          targetPort: 8443
          name: https

  gloo-mesh-enterprise:
    repo: https://storage.googleapis.com/gloo-mesh-enterprise/gloo-mesh-enterprise
    chart: gloo-mesh-enterprise
    revision: v2.1.0-rc3
    namespace: gloo-mesh
    globalValues:
      cluster: mgmt
    values:
      mgmtClusterName: mgmt
      glooMeshMgmtServer:
        serviceType: ClusterIP
      deploymentOverrides:
        spec:
          template:
            metadata:
              annotations:
                sidecar.istio.io/inject: "true"
              labels:
                istio.io/rev: "1-15"

  gloo-agent:
    repo: https://storage.googleapis.com/gloo-mesh-enterprise/gloo-mesh-agent
    chart: gloo-mesh-agent
    namespace: gloo-mesh
    revision: v2.1.0-rc3
    syncPolicy:
      syncOptions: [] # dont create namespace
    values:
      cluster: mgmt
      glooMeshAgent:
        enabled: true
      relay:
        serverAddress: "gloo-mesh-mgmt-server.gloo-mesh.svc.cluster.local:9900"
        authority: gloo-mesh-mgmt-server.gloo-mesh
        # clientTlsSecret:
        #   name: gloo-mesh-agent-mgmt-tls-cert
        #   namespace: gloo-mesh
        

  mgmt-workspace:
    path: charts/ws-single-cluster
    namespace: gloo-mesh
    syncPolicy:
      syncOptions: [] # dont create namespace

  # # the aws iam for service accounts webhook for non-eks
  # aws-iam:
  #   path: charts/aws-identity-webhook
  #   namespace: pod-identity-webhook
    
  # # # bookinfo sample apps
  # # bookinfo:
  # #   path: charts/bookinfo
  # #   namespace: bookinfo

  # gloo-mgmt:
  #   repo: https://storage.googleapis.com/gloo-mesh-enterprise/gloo-mesh-enterprise
  #   chart: gloo-mesh-enterprise
  #   namespace: gloo-mesh
  #   # revision set by ./cluster-app-of-apps/templates/app.yaml


  # register-cluster:
  #   path: charts/register-cluster
  #   namespace: gloo-mesh
  #   values:
  #     istio:
  #       clusterName: cluster1
  #   syncPolicy:
  #     syncOptions: [] # dont create namespace




  # workspace:
  #   path: charts/workspace
  #   namespace: gloo-mesh
  #   syncPolicy:
  #     syncOptions: [] # dont create namespace
  #   values:
  #     namespaces:
  #     - name: istio-ingress
  #     workspaces:
  #       gateway:
  #         namespace: istio-ingress
  #         spec:
  #           importFrom:
  #           - workspaces:
  #             - selector:
  #                 allow_ingress: "true"
  #             resources:
  #             - kind: SERVICE
  #             - kind: ALL
  #               labels:
  #                 expose: "true"
  #           exportTo:
  #           - workspaces:
  #             - selector:
  #                 allow_ingress: "true"
  #             resources:
  #             - kind: SERVICE

